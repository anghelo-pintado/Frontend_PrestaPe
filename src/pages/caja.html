<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Caja - PrestaPe</title>
    <link rel="stylesheet" href="../css/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
  </head>
  <body>
    <header class="navbar">
      <div class="navbar-brand">
        <i class="fa-solid fa-landmark"></i>
        <h1>PrestaPe</h1>
      </div>
      <nav class="navbar-nav">
        <a href="principal.html" class="nav-link">
          <i class="fa-solid fa-house"></i> Inicio
        </a>
        <a href="prestamos.html" class="nav-link">
          <i class="fa-solid fa-table-list"></i> Pr√©stamos
        </a>
        <a href="nuevo-prestamo.html" class="nav-link">
          <i class="fa-solid fa-circle-plus"></i> Nuevo Pr√©stamo
        </a>
        <a href="caja.html" class="nav-link active">
          <i class="fa-solid fa-cash-register"></i> Caja
        </a>
        <a href="perfil.html" class="nav-link">
          <i class="fas fa-user"></i> Perfil
        </a>
        <a href="#" id="logout-btn" class="nav-link"
          ><i class="fa-solid fa-right-from-bracket"></i> Salir</a
        >
      </nav>
    </header>

    <main class="container">
      <div class="main-title">
        <h2>Control de Caja</h2>
      </div>

      <section id="panel-caja-cerrada" class="card text-center hidden">
        <div class="empty-state">
          <i class="fa-solid fa-store-slash fa-4x text-muted"></i>
          <h3 class="mt-3">La caja est√° cerrada</h3>
          <p class="text-muted">Debe iniciar turno para registrar pagos.</p>

          <div class="form-group mt-4" style="max-width: 300px; margin: 0 auto">
            <label>Saldo Inicial (Dinero en caj√≥n)</label>
            <div class="input-group">
              <span class="input-group-text">S/</span>
              <input
                type="number"
                id="input-saldo-inicial"
                class="form-control text-center"
                value="0.00"
                min="0"
                step="0.10"
              />
            </div>
          </div>

          <button class="btn btn-primary mt-3" onclick="abrirCaja()">
            <i class="fa-solid fa-key"></i> Abrir Caja
          </button>
        </div>
      </section>

      <section id="panel-caja-abierta" class="hidden">
        <div class="dashboard-grid">
          <div class="card info-card">
            <!-- Header -->
            <div class="card-header-row">
              <h4><i class="fa-solid fa-shop"></i> Turno Activo</h4>
              <span class="badge badge-success">ABIERTA</span>
            </div>

            <!-- Datos iniciales -->
            <div class="info-item mt-3">
              <span>Apertura:</span>
              <strong id="lbl-fecha-apertura">--:--</strong>
            </div>

            <div class="info-item">
              <span>Saldo Inicial:</span>
              <strong id="lbl-saldo-inicial">S/ 0.00</strong>
            </div>

            <hr />

            <!-- Ingresos -->
            <h5 class="text-muted">Ingresos Registrados (Sistema)</h5>

            <div class="info-item">
              <span>Efectivo (+ Redondeo):</span>
              <strong id="lbl-ingreso-efectivo" class="text-success"
                >S/ 0.00</strong
              >
            </div>

            <div class="info-item">
              <span>Digital (Yape/Tarjeta):</span>
              <strong id="lbl-ingreso-digital" class="text-info"
                >S/ 0.00</strong
              >
            </div>

            <!-- ‚úÖ NUEVO: Reingresos -->
            <div class="info-item">
              <span><i class="fa-solid fa-coins text-success"></i> Reingresos:</span>
              <strong id="lbl-total-reingresos" class="text-success">S/ 0.00</strong>
            </div>

            <!-- ‚úÖ NUEVO: Vueltos -->
            <div class="info-item">
              <span><i class="fa-solid fa-hand-holding-dollar text-danger"></i> Vueltos Entregados:</span>
              <strong id="lbl-total-vueltos" class="text-danger">S/ 0.00</strong>
            </div>

            <hr />

            <div class="info-item mt-3" style="background: #e8f5e9; padding: 10px; border-radius: 5px;">
              <span><i class="fa-solid fa-money-bill-wave"></i> Efectivo Disponible (para vueltos):</span>
              <strong id="lbl-efectivo-disponible" class="text-success" style="font-size: 1.2em;">
                S/ 0.00
              </strong>
            </div>
            <small class="text-muted mt-1" style="display: block;">
              Este es el dinero que puedes usar para dar vueltos a los clientes.
            </small>

            <hr />

            <!-- Total esperado -->
            <div class="info-item total-esperado-box">
              <span><strong>üí∞ TOTAL ESPERADO EN CAJA:</strong></span>
              <strong
                id="lbl-total-esperado"
                class="text-success total-esperado-text"
              >
                S/ 0.00
              </strong>
            </div>

            <small class="text-muted">
              Este es el monto que debe coincidir con su conteo f√≠sico de
              efectivo.
            </small>
          </div>

          <div class="card action-card">
            <h4><i class="fa-solid fa-sack-dollar"></i> Arqueo y Cierre</h4>
            <p class="text-sm text-muted mb-3">
              Ingrese la cantidad de billetes y monedas que tiene f√≠sicamente.
              El sistema validar√° que coincida con lo registrado.
            </p>

            <div class="alert alert-warning">
              <strong
                ><i class="fa-solid fa-triangle-exclamation"></i>
                Importante:</strong
              >
              Solo cuente el dinero en <strong>EFECTIVO</strong>. No sume
              vouchers de Yape ni Tarjetas.
            </div>

            <div class="form-group mt-3">
              <label for="input-monto-fisico" class="font-bold"
                >Total Efectivo en Caj√≥n (S/)</label
              >
              <input
                type="number"
                id="input-monto-fisico"
                class="form-control input-lg"
                placeholder="0.00"
                step="0.01"
              />
              <small class="text-muted"
                >Debe coincidir con: Saldo Inicial + Ingresos + Reingresos - Vueltos</small
              >
            </div>

            <div class="form-group mt-3">
              <label for="input-observaciones"
                >Observaciones / Justificaci√≥n</label
              >
              <textarea
                id="input-observaciones"
                class="form-control"
                rows="2"
                placeholder="Ej: Faltan 0.10 c√©ntimos por redondeo..."
              ></textarea>
            </div>

            <button
              class="btn btn-danger btn-full-width mt-4"
              onclick="procesarCierre()"
            >
              <i class="fa-solid fa-lock"></i> Cuadrar y Cerrar Caja
            </button>
          </div>

          <!-- Card de Reingreso Manual -->
          <div class="card action-card">
            <h4><i class="fa-solid fa-coins"></i> Reingreso Manual</h4>
            <p class="text-sm text-muted mb-3">
              Si necesita agregar dinero a la caja (cambio del banco, pr√©stamo personal, etc.), reg√≠strelo aqu√≠ para mantener el control.
            </p>
            
            <button
              class="btn btn-success btn-full-width"
              onclick="abrirModalReingresoManual()">
              <i class="fa-solid fa-hand-holding-dollar"></i> Registrar Reingreso
            </button>
          </div>

          <!-- Card de Movimientos -->
          <div class="card movimientos-card">
            <h4><i class="fa-solid fa-list"></i> Movimientos de Caja</h4>
            
            <div class="resumen-movimientos">
              <div class="info-item">
                <span>Total Reingresos:</span>
                <strong id="lbl-total-reingresos" class="text-success">S/ 0.00</strong>
              </div>

            </div>

            <div class="table-container mt-3">
              <table class="table-sm">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Monto</th>
                    <th>Concepto</th>
                    <th>Fecha</th>
                    <th>Saldo</th>
                  </tr>
                </thead>
                <tbody id="tabla-movimientos-body">
                  <tr>
                    <td colspan="5" class="text-center text-muted">
                      <i class="fa-solid fa-inbox"></i> Sin movimientos a√∫n
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal Reingreso de Dinero (autom√°tico por falta de cambio) -->
    <div id="modal-reingreso" class="modal-overlay hidden">
      <div class="modal-box">
        <div class="modal-header">
          <h3>
            <i class="fa-solid fa-coins"></i> Reingreso de Dinero a Caja
          </h3>
          <button class="btn-close" onclick="cerrarModalReingreso()">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <strong>Falta dinero en caja para dar vuelto</strong>
          </div>

          <div class="info-box">
            <div class="info-item">
              <span>Vuelto a entregar:</span>
              <strong id="reingreso-vuelto-necesario" class="text-danger">S/ 0.00</strong>
            </div>
            <div class="info-item">
              <span>Efectivo disponible en caja:</span>
              <strong id="reingreso-disponible">S/ 0.00</strong>
            </div>
            <div class="info-item" style="border-top: 2px solid #dc3545; padding-top: 10px; margin-top: 10px;">
              <span><strong>Dinero faltante:</strong></span>
              <strong id="reingreso-faltante" class="text-danger" style="font-size: 1.3em;">
                S/ 0.00
              </strong>
            </div>
          </div>

          <div class="form-group mt-3">
            <label for="input-monto-reingreso">
              <i class="fa-solid fa-money-bill"></i> Monto a reingresar
            </label>
            <div class="input-group">
              <span class="input-group-text">S/</span>
              <input
                type="number"
                id="input-monto-reingreso"
                class="form-control"
                step="0.10"
                min="0"
                style="font-size: 1.2em; font-weight: bold;"
              />
            </div>
          </div>

          <div class="form-group mt-3">
            <label for="input-observacion-reingreso">
              Observaci√≥n / Raz√≥n del reingreso
            </label>
            <textarea
              id="input-observacion-reingreso"
              class="form-control"
              rows="2"
              placeholder="Ej: Reingreso por falta de cambio..."
              required
            ></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModalReingreso()">
            <i class="fa-solid fa-times"></i> Cancelar Pago
          </button>
          <button id="btn-confirmar-reingreso" class="btn btn-primary" onclick="confirmarReingreso()">
            <i class="fa-solid fa-check"></i> Confirmar Reingreso
          </button>
        </div>
      </div>
    </div>

    <!-- Modal Reingreso Manual -->
    <div id="modal-reingreso-manual" class="modal-overlay hidden">
      <div class="modal-box">
        <div class="modal-header">
          <h3>
            <i class="fa-solid fa-hand-holding-dollar"></i> Reingreso Manual de Dinero
          </h3>
          <button class="btn-close" onclick="cerrarModalReingresoManual()">
            <i class="fa-solid fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fa-solid fa-circle-info"></i>
            Registre cualquier ingreso de dinero externo a la caja (cambio del banco, aporte personal, pr√©stamo, etc.)
          </div>

          <div class="form-group">
            <label for="input-monto-manual">
              <i class="fa-solid fa-money-bill"></i> Monto a ingresar
            </label>
            <div class="input-group">
              <span class="input-group-text">S/</span>
              <input
                type="number"
                id="input-monto-manual"
                class="form-control"
                step="0.10"
                min="0.10"
                placeholder="0.00"
                style="font-size: 1.2em; font-weight: bold;"
                required
              />
            </div>
          </div>

          <div class="form-group mt-3">
            <label for="input-concepto-manual">
              <i class="fa-solid fa-file-lines"></i> Concepto / Motivo del ingreso
            </label>
            <textarea
              id="input-concepto-manual"
              class="form-control"
              rows="3"
              placeholder="Ej: Cambio tra√≠do del banco, Pr√©stamo personal para cambio, etc."
              required
            ></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="cerrarModalReingresoManual()">
            <i class="fa-solid fa-times"></i> Cancelar
          </button>
          <button class="btn btn-success" onclick="confirmarReingresoManual()">
            <i class="fa-solid fa-check"></i> Registrar Ingreso
          </button>
        </div>
      </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>
    <script src="../js/caja-logic.js"></script>
    <script>
      if (window.SisPrestaAuth) window.SisPrestaAuth.checkAuthAndRedirect();

      // ‚úÖ Funciones para el modal de reingreso manual
      function abrirModalReingresoManual() {
        document.getElementById('modal-reingreso-manual').classList.remove('hidden');
        document.getElementById('input-monto-manual').value = '';
        document.getElementById('input-concepto-manual').value = '';
        document.getElementById('input-monto-manual').focus();
      }

      function cerrarModalReingresoManual() {
        document.getElementById('modal-reingreso-manual').classList.add('hidden');
      }

      async function confirmarReingresoManual() {
        const monto = parseFloat(document.getElementById('input-monto-manual').value);
        const concepto = document.getElementById('input-concepto-manual').value.trim();

        // Validaciones
        if (!monto || monto <= 0) {
          alert('‚ö†Ô∏è Debe ingresar un monto v√°lido mayor a 0');
          return;
        }

        if (!concepto) {
          alert('‚ö†Ô∏è Debe especificar el concepto del ingreso');
          return;
        }

        const btn = event.target;
        const txtOriginal = btn.innerHTML;

        try {
          btn.disabled = true;
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Procesando...';

          // ‚úÖ Llamar a la API con el campo correcto "concepto"
          const response = await window.SisPrestaApi.registrarReingreso({
            monto: monto,
            concepto: concepto,  // ‚úÖ Usar "concepto" no "observacion"
            usuario: "Cajero"
          });

          alert(`‚úÖ Reingreso de ${fmtMoney(monto)} registrado correctamente\nEfectivo disponible: ${fmtMoney(response.efectivoDisponible)}`);
          cerrarModalReingresoManual();
          
          // Recargar la p√°gina para actualizar los datos
          window.location.reload();

        } catch (e) {
          console.error('Error al registrar reingreso:', e);
          alert('‚ùå Error al registrar reingreso: ' + e.message);
        } finally {
          btn.disabled = false;
          btn.innerHTML = txtOriginal;
        }
      }

      function fmtMoney(n) {
        return "S/ " + Number(n).toFixed(2);
      }

      // Cerrar modales con ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          cerrarModalReingresoManual();
        }
      });
    </script>
  </body>
</html>
