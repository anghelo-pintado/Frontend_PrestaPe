<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil de Usuario - App de Préstamos</title>

    <!-- Tu hoja de estilos principal -->
    <link rel="stylesheet" href="../css/styles.css" />

    <!-- Iconos de Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <style>
      /* Estilo para la alerta de éxito, complementando tu CSS */
      .alert-success {
        background-color: #f0f9eb;
        color: #4f7c2a;
        border-color: #d1e7dd;
      }

      /* Pequeño ajuste para centrar el contenedor del formulario */
      .container {
        max-width: 600px;
      }

      /* Asegurarnos que el input de password tome el mismo estilo que los de texto */
      .form-group input[type="password"] {
        width: 100%;
        padding: 0.8rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 1rem;
        background-color: white;
        color: var(--text-color);
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .form-group input[type="password"]:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(26, 188, 156, 0.2);
        outline: none;
      }
    </style>
  </head>
  <body>
    <!-- Navbar simple para dar contexto y permitir navegación -->
    <nav class="navbar">
      <div class="navbar-brand">
        <i class="fa-solid fa-landmark"></i>
        <h1>PrestaPe</h1>
      </div>
      <div class="navbar-nav">
        <a href="principal.html" class="nav-link">
          <i class="fa-solid fa-house"></i> Inicio
        </a>
        <a href="prestamos.html" class="nav-link">
          <i class="fa-solid fa-table-list"></i> Préstamos
        </a>
        <a href="nuevo-prestamo.html" class="nav-link">
          <i class="fa-solid fa-circle-plus"></i> Nuevo Préstamo
        </a>
        <a href="caja.html" class="nav-link">
          <i class="fa-solid fa-cash-register"></i> Caja
        </a>
        <a href="perfil.html" class="nav-link active">
          <i class="fas fa-user"></i> Perfil
        </a>
        <a href="#" id="logout-btn" class="nav-link">
          <i class="fa-solid fa-right-from-bracket"></i> Salir
        </a>
      </div>
    </nav>

    <div class="container">
      <!-- Usamos la clase .form-container que ya tienes definida -->
      <div class="form-container">
        <h2>Cambiar Contraseña</h2>
        <p>
          Para proteger tu cuenta, elige una contraseña segura y no la
          compartas.
        </p>

        <form id="change-password-form" novalidate>
          <!-- Campo de Contraseña Actual -->
          <div class="form-group">
            <label for="current-password">Contraseña Actual</label>
            <input
              type="password"
              id="current-password"
              name="current-password"
              required
            />
          </div>

          <!-- Campo de Nueva Contraseña -->
          <div class="form-group">
            <label for="new-password">Nueva Contraseña</label>
            <input
              type="password"
              id="new-password"
              name="new-password"
              maxlength="12"
              required
            />
          </div>

          <!-- Campo para Confirmar Nueva Contraseña -->
          <div class="form-group">
            <label for="confirm-password">Confirmar Nueva Contraseña</label>
            <input
              type="password"
              id="confirm-password"
              name="confirm-password"
              maxlength="12"
              required
            />
          </div>

          <!-- Alerta de éxito (oculta por defecto) -->
          <div class="alert alert-success hidden" id="success-message">
            <i class="fas fa-check-circle"></i>
            <div>
              <strong>¡Éxito!</strong>
              <span>Tu contraseña ha sido actualizada correctamente.</span>
            </div>
          </div>

          <!-- Alerta de error (oculta por defecto) -->
          <div class="alert alert-danger hidden" id="error-message">
            <i class="fas fa-times-circle"></i>
            <div>
              <strong>Error al actualizar</strong>
              <span id="error-text">Por favor, corrige los errores.</span>
            </div>
          </div>

          <!-- Botón de envío -->
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            <span>Guardar Cambios</span>
          </button>
        </form>
      </div>
    </div>

    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (
          window.SisPrestaAuth &&
          typeof window.SisPrestaAuth.checkAuthAndRedirect === "function"
        ) {
          window.SisPrestaAuth.checkAuthAndRedirect();
        }

        const form = document.getElementById("change-password-form");
        const currentPasswordInput =
          document.getElementById("current-password");
        const newPasswordInput = document.getElementById("new-password");
        const confirmPasswordInput =
          document.getElementById("confirm-password");
        const successMessage = document.getElementById("success-message");
        const errorMessage = document.getElementById("error-message");
        const errorText = document.getElementById("error-text");
        const submitButton = form.querySelector('button[type="submit"]');

        function getUserEmailFromToken() {
          if (!window.SisPrestaAuth) return null;
          const token = window.SisPrestaAuth.getAccessToken();
          if (!token) return null;
          try {
            // El email usualmente se encuentra en el claim 'sub' (subject) del JWT
            const payload = JSON.parse(atob(token.split(".")[1]));
            return payload.sub;
          } catch (e) {
            console.error("Error al decodificar el token:", e);
            return null;
          }
        }

        form.addEventListener("submit", async (event) => {
          event.preventDefault();

          // Ocultar mensajes previos
          successMessage.classList.add("hidden");
          errorMessage.classList.add("hidden");

          const currentPassword = currentPasswordInput.value;
          const newPassword = newPasswordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          // --- VALIDACIONES DEL LADO DEL CLIENTE ---
          if (!currentPassword || !newPassword || !confirmPassword) {
            errorText.textContent = "Todos los campos son obligatorios.";
            errorMessage.classList.remove("hidden");
            return;
          }

          if (newPassword !== confirmPassword) {
            errorText.textContent =
              "La nueva contraseña y su confirmación no coinciden.";
            errorMessage.classList.remove("hidden");
            return;
          }

          // Reglas: longitud 8-12, al menos un número, al menos una minúscula,
          // al menos una mayúscula, y ningún carácter especial (solo letras y números).
          const pwdRegex =
            /^(?=.{8,12}$)(?=.*\d)(?=.*[a-z])(?=.*[A-Z])[A-Za-z0-9]+$/;

          if (!pwdRegex.test(newPassword)) {
            errorText.textContent =
              "La contraseña debe tener entre 8 y 12 caracteres, incluir al menos una letra mayúscula, una letra minúscula y un número, y no puede contener caracteres especiales.";
            errorMessage.classList.remove("hidden");
            return;
          }

          // --- SIMULACIÓN DE LLAMADA AL BACKEND ---
          // Aquí harías una llamada a tu API para cambiar la contraseña.
          // El backend debería verificar si la 'currentPassword' es correcta.

          submitButton.disabled = true;
          submitButton.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Guardando...`;

          const userEmail = getUserEmailFromToken();
          if (!userEmail) {
            errorText.textContent =
              "No se pudo verificar tu identidad. Por favor, inicia sesión de nuevo.";
            errorMessage.classList.remove("hidden");
            submitButton.disabled = false;
            submitButton.innerHTML = `<i class="fas fa-save"></i> Guardar Cambios`;
            return;
          }

          const requestBody = {
            email: userEmail,
            password: currentPassword,
            newPassword: newPassword,
          };

          try {
            // Preferir SisPrestaAuth.apiFetch (ya maneja API_BASE_URL y Authorization)
            if (
              window.SisPrestaAuth &&
              typeof window.SisPrestaAuth.apiFetch === "function"
            ) {
              const resp = await window.SisPrestaAuth.apiFetch(
                "/auth/actualizar",
                {
                  method: "POST",
                  body: JSON.stringify(requestBody),
                }
              );
              if (!resp || !resp.ok) {
                const errBody = await resp?.json().catch(() => null);
                const err = new Error(
                  "Error en la petición: " + (resp?.status || "unknown")
                );
                err.payload = errBody;
                throw err;
              }
            } else if (
              window.SisPrestaApi &&
              typeof window.SisPrestaApi.request === "function"
            ) {
              // Si existe ese módulo, usarlo (compatibilidad)
              await window.SisPrestaApi.request("/auth/actualizar", {
                method: "POST",
                body: requestBody,
              });
            } else {
              // Fallback directo con fetch: construye endpoint desde config disponible
              const base =
                (window.SisPrestaAuth && window.SisPrestaAuth.API_BASE_URL) ||
                (window.SisPrestaConfig && window.SisPrestaConfig.apiBase) ||
                "";
              const endpoint =
                (base ? base.replace(/\/+$/, "") : "") + "/auth/actualizar";
              const token = window.SisPrestaAuth?.getAccessToken?.() || "";

              const resp = await fetch(endpoint, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  ...(token ? { Authorization: "Bearer " + token } : {}),
                },
                body: JSON.stringify(requestBody),
              });

              if (!resp.ok) {
                const errBody = await resp.json().catch(() => null);
                const err = new Error("Error en la petición: " + resp.status);
                err.payload = errBody;
                throw err;
              }
            }

            successMessage.classList.remove("hidden");
            form.reset();
          } catch (error) {
            console.error("Error al actualizar:", error);
            errorText.textContent =
              error.payload?.message ||
              error.message ||
              "La contraseña actual es incorrecta o hubo un error.";
            errorMessage.classList.remove("hidden");
          } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = `<i class="fas fa-save"></i> Guardar Cambios`;
          }
        });
      });
    </script>
  </body>
</html>
